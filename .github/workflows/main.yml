name: Deploy CLT

on:
  push:
    branches: [ main ]        # change if your default branch is different
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install deps
        run: npm ci

      - name: Build
        run: npm run build

      - name: Detect output dir
        id: out
        run: |
          if [ -d "dist" ]; then echo "dir=dist" >> "$GITHUB_OUTPUT"; else echo "dir=build" >> "$GITHUB_OUTPUT"; fi

      - name: Setup SSH
        env:
          SSH_KEY: ${{ secrets.HOSTINGER_SSH_KEY }}
          SSH_HOST: ${{ secrets.HOSTINGER_HOST }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          # (Optional) lock to known host to avoid prompts
          ssh-keyscan -p "${{ secrets.HOSTINGER_PORT || '65002' }}" "$SSH_HOST" >> ~/.ssh/known_hosts

      - name: Deploy with rsync over SSH
        env:
          SSH_HOST: ${{ secrets.HOSTINGER_HOST }}
          SSH_USER: ${{ secrets.HOSTINGER_USER }}
          SSH_PORT: ${{ secrets.HOSTINGER_PORT }}
          TARGET: ${{ secrets.HOSTINGER_PATH_CLT }}
        run: |
          RSYNC_SRC="${{ steps.out.outputs.dir }}/"
          PORT="${SSH_PORT:-65002}"
          rsync -az --delete -e "ssh -p $PORT" "$RSYNC_SRC" "$SSH_USER@$SSH_HOST:$TARGET"
